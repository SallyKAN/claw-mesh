<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>claw-mesh Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--border:#2a2d3a;--text:#e4e4e7;--muted:#71717a;--accent:#6366f1;--accent-hover:#818cf8;--green:#22c55e;--red:#ef4444;--yellow:#eab308;--blue:#3b82f6}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
.container{max-width:1200px;margin:0 auto;padding:24px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;padding-bottom:16px;border-bottom:1px solid var(--border)}
header h1{font-size:24px;font-weight:700;display:flex;align-items:center;gap:10px}
header h1 span{color:var(--accent)}
.badge{font-size:11px;padding:2px 8px;border-radius:12px;background:var(--accent);color:#fff;font-weight:500}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px}
.stat-card .label{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.stat-card .value{font-size:32px;font-weight:700}
.stat-card .value.online{color:var(--green)}
.stat-card .value.busy{color:var(--yellow)}
.stat-card .value.offline{color:var(--red)}
section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:24px}
section h2{font-size:16px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;padding:8px 12px;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
tr:last-child td{border-bottom:none}
.status{display:inline-flex;align-items:center;gap:6px;font-size:13px;font-weight:500}
.status::before{content:'';width:8px;height:8px;border-radius:50%}
.status.online::before{background:var(--green)}
.status.busy::before{background:var(--yellow)}
.status.offline::before{background:var(--red)}
.tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:6px;background:var(--border);color:var(--muted);margin:1px 2px}
.btn{padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;font-size:13px;transition:all 0.15s}
.btn:hover{border-color:var(--accent);color:var(--accent)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-hover)}
.btn-danger{color:var(--red);border-color:transparent}
.btn-danger:hover{background:rgba(239,68,68,0.1);border-color:var(--red)}
.send-form{display:flex;gap:12px;align-items:flex-end}
.send-form .field{flex:1;display:flex;flex-direction:column;gap:4px}
.send-form label{font-size:12px;color:var(--muted)}
.send-form select,.send-form input{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:14px}
.send-form select:focus,.send-form input:focus{outline:none;border-color:var(--accent)}
.result{margin-top:12px;padding:12px;border-radius:8px;font-size:13px;font-family:monospace;display:none}
.result.ok{display:block;background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.2)}
.result.err{display:block;background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2)}
.empty{text-align:center;padding:32px;color:var(--muted);font-size:14px}
.refresh-info{font-size:12px;color:var(--muted)}
@media(max-width:768px){.stats{grid-template-columns:repeat(2,1fr)}.send-form{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ðŸ¦ž <span>claw-mesh</span> Dashboard</h1>
    <div class="refresh-info">Auto-refresh: 5s</div>
  </header>

  <div class="stats">
    <div class="stat-card"><div class="label">Total Nodes</div><div class="value" id="total">-</div></div>
    <div class="stat-card"><div class="label">Online</div><div class="value online" id="online">-</div></div>
    <div class="stat-card"><div class="label">Busy</div><div class="value busy" id="busy">-</div></div>
    <div class="stat-card"><div class="label">Offline</div><div class="value offline" id="offline">-</div></div>
  </div>

  <section>
    <h2>ðŸ“¡ Nodes</h2>
    <div id="nodes-table"></div>
  </section>

  <section>
    <h2>ðŸ”€ Routing Rules</h2>
    <div id="rules-table"></div>
  </section>

  <section>
    <h2>ðŸ’¬ Send Message</h2>
    <div class="send-form">
      <div class="field"><label>Target</label><select id="send-target"><option value="auto">Auto-route</option></select></div>
      <div class="field" style="flex:3"><label>Message</label><input id="send-msg" type="text" placeholder="Type a message..."></div>
      <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>
    <div class="result" id="send-result"></div>
  </section>
</div>

<script>
const API = window.location.origin;
let nodesCache = [];

async function fetchJSON(path) {
  const r = await fetch(API + path);
  if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

function statusHTML(s) {
  return `<span class="status ${s}">${s}</span>`;
}

function tagsHTML(tags) {
  if (!tags || !tags.length) return '<span class="tag">none</span>';
  return tags.map(t => `<span class="tag">${esc(t)}</span>`).join('');
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function matchDesc(m) {
  if (m.wildcard) return '*';
  const p = [];
  if (m.requires_gpu) p.push('gpu:true');
  if (m.requires_os) p.push('os:' + m.requires_os);
  if (m.requires_skill) p.push('skill:' + m.requires_skill);
  return p.join(', ') || '-';
}

async function refresh() {
  try {
    const nodes = await fetchJSON('/api/v1/nodes');
    nodesCache = nodes || [];
    let on=0, busy=0, off=0;
    (nodes||[]).forEach(n => {
      if (n.status==='online') on++;
      else if (n.status==='busy') busy++;
      else off++;
    });
    document.getElementById('total').textContent = (nodes||[]).length;
    document.getElementById('online').textContent = on;
    document.getElementById('busy').textContent = busy;
    document.getElementById('offline').textContent = off;

    const nt = document.getElementById('nodes-table');
    if (!nodes || !nodes.length) {
      nt.innerHTML = '<div class="empty">No nodes registered</div>';
    } else {
      nt.innerHTML = `<table><thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Endpoint</th><th>OS/Arch</th><th>GPU</th><th>Skills</th><th>Tags</th></tr></thead><tbody>${
        nodes.map(n => `<tr>
          <td><code>${esc(n.id).slice(0,12)}</code></td>
          <td>${esc(n.name)}</td>
          <td>${statusHTML(n.status)}</td>
          <td><code>${esc(n.endpoint)}</code></td>
          <td>${esc(n.capabilities?.os||'-')}/${esc(n.capabilities?.arch||'-')}</td>
          <td>${n.capabilities?.gpu?'âœ…':'â€”'}</td>
          <td>${tagsHTML(n.capabilities?.skills)}</td>
          <td>${tagsHTML(n.capabilities?.tags)}</td>
        </tr>`).join('')
      }</tbody></table>`;
    }

    // Update send target dropdown
    const sel = document.getElementById('send-target');
    const cur = sel.value;
    sel.innerHTML = '<option value="auto">Auto-route</option>';
    (nodes||[]).forEach(n => {
      sel.innerHTML += `<option value="${esc(n.id)}">${esc(n.name)} (${n.status})</option>`;
    });
    sel.value = cur;
  } catch(e) { console.error('refresh nodes:', e); }

  try {
    const rules = await fetchJSON('/api/v1/rules');
    const rt = document.getElementById('rules-table');
    if (!rules || !rules.length) {
      rt.innerHTML = '<div class="empty">No routing rules configured</div>';
    } else {
      rt.innerHTML = `<table><thead><tr><th>ID</th><th>Match</th><th>Target</th><th>Strategy</th><th></th></tr></thead><tbody>${
        rules.map(r => `<tr>
          <td><code>${esc(r.id).slice(0,12)}</code></td>
          <td>${esc(matchDesc(r.match))}</td>
          <td>${esc(r.target||'-')}</td>
          <td>${esc(r.strategy||'least-busy')}</td>
          <td><button class="btn btn-danger" onclick="deleteRule('${esc(r.id)}')">âœ•</button></td>
        </tr>`).join('')
      }</tbody></table>`;
    }
  } catch(e) { console.error('refresh rules:', e); }
}

async function deleteRule(id) {
  try {
    await fetch(API + '/api/v1/rules/' + id, {method:'DELETE'});
    refresh();
  } catch(e) { console.error('delete rule:', e); }
}

async function sendMessage() {
  const target = document.getElementById('send-target').value;
  const msg = document.getElementById('send-msg').value.trim();
  const res = document.getElementById('send-result');
  if (!msg) return;

  const url = target === 'auto' ? '/api/v1/route' : '/api/v1/route/' + target;
  try {
    const r = await fetch(API + url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({content: msg, source: 'dashboard'})
    });
    const data = await r.json();
    if (r.ok) {
      res.className = 'result ok';
      res.textContent = `âœ“ Routed to ${data.node_id} â€” Response: ${data.response}`;
    } else {
      res.className = 'result err';
      res.textContent = `âœ— ${data.error || r.statusText}`;
    }
  } catch(e) {
    res.className = 'result err';
    res.textContent = `âœ— ${e.message}`;
  }
  document.getElementById('send-msg').value = '';
}

document.getElementById('send-msg').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendMessage();
});

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>
