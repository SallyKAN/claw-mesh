<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>claw-mesh</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--border:#2a2d3a;--text:#e4e4e7;--muted:#71717a;--accent:#6366f1;--accent-hover:#818cf8;--green:#22c55e;--red:#ef4444;--yellow:#eab308;--blue:#3b82f6;--msg-user:#6366f1;--msg-ai:#1e2030}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;height:100vh;overflow:hidden}

/* Layout: sidebar + chat */
.app{display:flex;height:100vh}

/* Right sidebar */
.sidebar{width:280px;min-width:280px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width 0.2s,min-width 0.2s}
.sidebar.collapsed{width:0;min-width:0;border-left:none}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sidebar-header h2{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px}
.sidebar-content{flex:1;overflow-y:auto;padding:12px}
.node-count{font-size:11px;color:var(--muted);padding:2px 8px;border-radius:10px;background:var(--bg)}

/* Node cards */
.node-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;transition:border-color 0.15s}
.node-card:hover{border-color:var(--accent)}
.node-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.node-name{font-size:13px;font-weight:600}
.node-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.node-dot.online{background:var(--green)}
.node-dot.busy{background:var(--yellow)}
.node-dot.offline{background:var(--red)}
.node-meta{font-size:11px;color:var(--muted);margin-bottom:6px}
.node-tags{display:flex;flex-wrap:wrap;gap:3px}
.tag{display:inline-block;font-size:10px;padding:1px 6px;border-radius:4px;background:var(--border);color:var(--muted)}

/* Chat area */
.chat{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface)}
.chat-header h1{font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
.chat-header h1 em{font-style:normal;color:var(--accent)}
.header-actions{display:flex;align-items:center;gap:8px}
.icon-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.15s}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
.icon-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}
.messages::-webkit-scrollbar{width:6px}
.messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.msg{max-width:75%;display:flex;flex-direction:column;gap:4px}
.msg.user{align-self:flex-end}
.msg.ai{align-self:flex-start}
.msg-bubble{padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.5;word-break:break-word}
.msg.user .msg-bubble{background:var(--msg-user);color:#fff;border-bottom-right-radius:4px}
.msg.ai .msg-bubble{background:var(--msg-ai);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg-info{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px}
.msg.user .msg-info{justify-content:flex-end}
.routed-badge{font-size:10px;padding:1px 6px;border-radius:4px;background:rgba(99,102,241,0.15);color:var(--accent)}
.msg-time{font-size:10px;color:var(--muted)}

/* Typing indicator */
.typing{display:none;align-self:flex-start;padding:10px 14px;background:var(--msg-ai);border:1px solid var(--border);border-radius:16px;border-bottom-left-radius:4px}
.typing.show{display:flex;align-items:center;gap:4px}
.typing span{width:6px;height:6px;border-radius:50%;background:var(--muted);animation:bounce 1.4s infinite}
.typing span:nth-child(2){animation-delay:0.2s}
.typing span:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}

/* Welcome state */
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--muted);padding:40px}
.welcome-icon{font-size:48px;margin-bottom:8px}
.welcome h2{font-size:18px;color:var(--text);font-weight:600}
.welcome p{font-size:14px;text-align:center;max-width:400px}

/* Input area */
.input-area{padding:16px 20px;border-top:1px solid var(--border);background:var(--surface)}
.input-row{display:flex;gap:10px;align-items:flex-end}
.input-wrapper{flex:1;position:relative}
.input-wrapper textarea{width:100%;padding:10px 14px;padding-right:40px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:14px;font-family:inherit;resize:none;line-height:1.5;min-height:42px;max-height:120px;overflow-y:auto}
.input-wrapper textarea:focus{outline:none;border-color:var(--accent)}
.input-wrapper textarea::placeholder{color:var(--muted)}
.send-btn{width:42px;height:42px;border-radius:12px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;flex-shrink:0}
.send-btn:hover{background:var(--accent-hover)}
.send-btn:disabled{opacity:0.4;cursor:not-allowed}
.send-btn svg{width:18px;height:18px}
.input-hint{display:flex;align-items:center;justify-content:space-between;margin-top:6px;font-size:11px;color:var(--muted)}
.route-select{padding:2px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--muted);font-size:11px;cursor:pointer}
.route-select:focus{outline:none;border-color:var(--accent)}

/* Empty sidebar */
.sidebar-empty{text-align:center;padding:32px 16px;color:var(--muted);font-size:13px}

/* Responsive */
@media(max-width:768px){
  .sidebar{position:fixed;right:0;top:0;bottom:0;z-index:10;width:280px;min-width:280px;transform:translateX(100%);transition:transform 0.2s}
  .sidebar.open{transform:translateX(0)}
  .sidebar.collapsed{transform:translateX(100%)}
  .msg{max-width:90%}
}
</style>
</head>
<body>
<div class="app">
  <!-- Chat main area -->
  <div class="chat">
    <div class="chat-header">
      <h1><em>claw-mesh</em></h1>
      <div class="header-actions">
        <div id="online-indicator" style="font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px">
          <span class="node-dot online" style="width:6px;height:6px"></span>
          <span id="online-count">0</span> nodes
        </div>
        <button class="icon-btn" id="sidebar-toggle" title="Toggle nodes panel" onclick="toggleSidebar()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="2" width="14" height="12" rx="2"/><line x1="10" y1="2" x2="10" y2="14"/></svg>
        </button>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <div class="welcome-icon">&#129438;</div>
        <h2>claw-mesh</h2>
        <p>One mesh, many claws. Type a message and it will be routed to the best available node automatically.</p>
      </div>
    </div>

    <div class="typing" id="typing"><span></span><span></span><span></span></div>

    <div class="input-area">
      <div class="input-row">
        <div class="input-wrapper">
          <textarea id="msg-input" rows="1" placeholder="Send a message..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        </div>
        <button class="send-btn" id="send-btn" onclick="sendMessage()" title="Send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
      <div class="input-hint">
        <span>Enter to send, Shift+Enter for newline</span>
        <select class="route-select" id="route-target">
          <option value="auto">Auto-route</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Right sidebar: nodes -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Nodes <span class="node-count" id="node-count">0</span></h2>
    </div>
    <div class="sidebar-content" id="nodes-list">
      <div class="sidebar-empty">No nodes registered</div>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
const TOKEN = window.__TOKEN__ || '';
let nodesCache = [];
let chatHistory = [];

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function timeStr() {
  return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

// --- Sidebar ---
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const btn = document.getElementById('sidebar-toggle');
  sb.classList.toggle('collapsed');
  btn.classList.toggle('active', !sb.classList.contains('collapsed'));
}

// --- Nodes ---
async function refreshNodes() {
  try {
    const nodes = await fetch(API + '/api/v1/nodes').then(r => r.ok ? r.json() : []);
    nodesCache = nodes || [];

    // Online count in header
    const onCount = nodesCache.filter(n => n.status === 'online' || n.status === 'busy').length;
    document.getElementById('online-count').textContent = onCount;
    document.getElementById('node-count').textContent = nodesCache.length;

    // Update route dropdown
    const sel = document.getElementById('route-target');
    const cur = sel.value;
    sel.innerHTML = '<option value="auto">Auto-route</option>';
    nodesCache.forEach(n => {
      sel.innerHTML += `<option value="${esc(n.id)}">${esc(n.name)}</option>`;
    });
    sel.value = cur;

    // Render node cards
    const list = document.getElementById('nodes-list');
    if (!nodesCache.length) {
      list.innerHTML = '<div class="sidebar-empty">No nodes registered.<br>Run <code>claw-mesh join</code> to add one.</div>';
      return;
    }
    list.innerHTML = nodesCache.map(n => `
      <div class="node-card">
        <div class="node-card-header">
          <span class="node-name">${esc(n.name)}</span>
          <span class="node-dot ${n.status}" title="${n.status}"></span>
        </div>
        <div class="node-meta">${esc(n.capabilities?.os||'?')}/${esc(n.capabilities?.arch||'?')} ${n.capabilities?.gpu?'&middot; GPU':''}</div>
        <div class="node-tags">
          ${(n.capabilities?.skills||[]).map(s=>`<span class="tag">${esc(s)}</span>`).join('')}
          ${(n.capabilities?.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('')}
          ${!(n.capabilities?.skills?.length||n.capabilities?.tags?.length)?'<span class="tag">no tags</span>':''}
        </div>
      </div>
    `).join('');
  } catch(e) { console.error('refreshNodes:', e); }
}

// --- Chat ---
function addMessage(role, text, meta) {
  const welcome = document.getElementById('welcome');
  if (welcome) welcome.style.display = 'none';

  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;

  let infoHTML = `<span class="msg-time">${timeStr()}</span>`;
  if (meta?.node_id) {
    const nodeName = nodesCache.find(n => n.id === meta.node_id)?.name || meta.node_id.slice(0,8);
    infoHTML += ` <span class="routed-badge">${esc(nodeName)}</span>`;
  }

  div.innerHTML = `
    <div class="msg-bubble">${esc(text)}</div>
    <div class="msg-info">${infoHTML}</div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  chatHistory.push({role, text, meta});
}

function showTyping(show) {
  const t = document.getElementById('typing');
  t.classList.toggle('show', show);
  if (show) {
    const container = document.getElementById('messages');
    container.scrollTop = container.scrollHeight;
  }
}

async function sendMessage() {
  const input = document.getElementById('msg-input');
  const msg = input.value.trim();
  if (!msg) return;

  const target = document.getElementById('route-target').value;
  input.value = '';
  autoResize(input);

  addMessage('user', msg);
  showTyping(true);
  document.getElementById('send-btn').disabled = true;

  const url = target === 'auto' ? '/api/v1/route' : '/api/v1/route/' + target;
  try {
    const r = await fetch(API + url, {
      method: 'POST',
      headers: {'Content-Type':'application/json', ...(TOKEN ? {'Authorization':'Bearer '+TOKEN} : {})},
      body: JSON.stringify({content: msg, source: 'dashboard'})
    });
    const data = await r.json();
    showTyping(false);
    if (r.ok) {
      addMessage('ai', data.response || 'Message routed successfully.', {node_id: data.node_id});
    } else {
      addMessage('ai', 'Error: ' + (data.error || r.statusText));
    }
  } catch(e) {
    showTyping(false);
    addMessage('ai', 'Failed to send: ' + e.message);
  }
  document.getElementById('send-btn').disabled = false;
  input.focus();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// --- Init ---
refreshNodes();
setInterval(refreshNodes, 5000);
document.getElementById('msg-input').focus();
</script>
</body>
</html>
